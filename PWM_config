#include <Wire.h>

#define AS5600_ADDR 0x36
#define REG_CONF_HIGH 0x07
#define REG_CONF_LOW  0x08

const int PWM_PIN = 7;               // AS5600 OUT æ¥ D7
const float PWM_PERIOD = 1100.0;     // 910Hz â†’ 1.1ms å‘¨æœŸ

void setup() {
  Serial.begin(9600);
  Wire.begin();
  pinMode(PWM_PIN, INPUT);
  delay(500);

  Serial.println("ğŸ”§ é…ç½® AS5600 ä¸º PWM æ¨¡å¼ï¼ˆ910Hzï¼‰...");

  // å†™ CONF å¯„å­˜å™¨ï¼Œé…ç½®ä¸º PWM è¾“å‡º + 910Hz
  uint8_t confHigh = 0x38;
  uint8_t confLow  = 0xE0;  // 11100000b â†’ PWMF=11, OUTS=10

  Wire.beginTransmission(AS5600_ADDR);
  Wire.write(REG_CONF_HIGH);
  Wire.write(confHigh);
  Wire.write(confLow);
  Wire.endTransmission();

  delay(100);

  // å†è¯»å›éªŒè¯
  Wire.beginTransmission(AS5600_ADDR);
  Wire.write(REG_CONF_HIGH);
  Wire.endTransmission();
  Wire.requestFrom(AS5600_ADDR, 2);
  uint8_t readHigh = Wire.read();
  uint8_t readLow  = Wire.read();

  Serial.print("CONF HIGH: 0x"); Serial.println(readHigh, HEX);
  Serial.print("CONF LOW : 0x"); Serial.println(readLow, HEX);

  if ((readLow & 0b00110000) == 0b00100000) {
    Serial.println("âœ… å·²è¿›å…¥ PWM æ¨¡å¼");
  } else {
    Serial.println("âŒ é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ PGO å¼•è„šæˆ–æ¥çº¿");
  }

  Serial.println("ğŸ“¡ å¼€å§‹è¾“å‡ºåŸå§‹è§’åº¦å€¼ï¼ˆæ— æ»¤æ³¢ï¼‰...");
}

void loop() {
  uint32_t high_time = pulseIn(PWM_PIN, HIGH, 30000);  // ç­‰å¾… 30ms

  if (high_time == 0) {
    Serial.println("âš ï¸ æœªæ£€æµ‹åˆ° PWM ä¿¡å·");
  } else if (high_time > 1200) {
    Serial.print("â— å¼‚å¸¸è„‰å†²å®½åº¦ï¼š"); Serial.print(high_time); Serial.println(" us");
  } else {
    float duty = high_time / PWM_PERIOD;
    float angle = duty * 360.0;

    Serial.print("âœ… High: "); Serial.print(high_time); Serial.print(" us\t");
    Serial.print("Duty: "); Serial.print(duty * 100, 1); Serial.print("%\t");
    Serial.print("Angle: "); Serial.print(angle, 1); Serial.println("Â°");
  }

  delay(300);
}
